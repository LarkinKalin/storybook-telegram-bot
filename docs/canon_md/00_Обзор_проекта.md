00_Обзор_проекта.md (серверная карта)
ID: SKAZKA-TG-OVERVIEW-00
Версия: v0.1
Статус: DRAFT
Дата: 2026-01-16
Владелец: Архитектор
________________________________________
1. Назначение файла
Этот документ фиксирует серверную структуру проекта:
•	где лежит репозиторий кода,
•	где лежат секреты/конфиги,
•	где лежат логи,
•	где лежат данные и бэкапы,
•	какие сервисы запускаются и чем управляются.
________________________________________
2. Размещение на сервере (корни)
Рекомендуемые корневые пути (просто и привычно):
•	Репозиторий: /srv/git/skazka/
•	Конфиги и секреты: /etc/skazka/
•	Данные приложения: /var/lib/skazka/
•	Логи: /var/log/skazka/
•	Бэкапы: /var/backups/skazka/
________________________________________
3. Дерево: репозиторий кода (на сервере)
/srv/git/skazka/:
skazka/
  README.md
  apps/
    tg-bot/
      src/
      tests/
      pyproject.toml (или package.json)
  packages/
    engine/
      src/
      tests/
    llm/
      src/
      prompt_templates/
    filters/
      src/
      dictionaries/
    payments-ton/
      src/
    db/
      src/
      migrations/
  infra/
    env.example
    docker/
      docker-compose.yml
      Dockerfile
    systemd/
      skazka-bot.service
      skazka-worker.service
  scripts/
    migrate.sh
    cleanup_30d.sh
    backup_db.sh
    restore_db.sh
  tests/
    smoke/
    integration/
Правило: движок живёт в packages/engine/. Он не размазывается по apps/tg-bot.
________________________________________
4. Дерево: окружение и данные (вне репозитория)
Это важно: секреты/логи/бэкапы НЕ живут в git.
4.1. Конфиги и секреты
/etc/skazka/:
/etc/skazka/
  skazka.env          # BOT_TOKEN, DB_URL, LLM_KEY, TON_KEY, etc (только секреты)
  allowed_hosts.txt   # (опционально)
  dictionaries/       # (опционально, если словари хочешь вне кода)
4.2. Данные приложения
/var/lib/skazka/:
/var/lib/skazka/
  runtime/            # временные файлы, кеши
  exports/            # выгрузки (если появятся)
  uploads/            # если появятся загрузки (скорее нет)
4.3. Логи
/var/log/skazka/:
/var/log/skazka/
  app.log
  bot.log
  llm.log
  payments.log
  errors.log
4.4. Бэкапы
/var/backups/skazka/:
/var/backups/skazka/
  postgres/
    daily/
    weekly/
  logs/
    daily/
________________________________________
5. Сервисы и управление запуском
Минимальный набор сервисов для MVP:
•	skazka-bot
Telegram бот, отвечает пользователям.
•	skazka-worker
Фоновые задачи:
o	проверка оплат TON (если нужно),
o	очистка данных старше 30 дней (или это cron/job).
•	postgres
База данных. Вариант: docker-контейнер или системный сервис.
Управление (выбирается один стиль):
•	systemd (infra/systemd/*.service)
или
•	docker compose (infra/docker/docker-compose.yml)
________________________________________
6. Политика “что где хранится”
•	Пользователи/сессии/платежи/история шагов: Postgres (таблицы фиксируются в отдельном доке БД).
•	Промпты и шаблоны: в репозитории (packages/llm/prompt_templates/) для версионирования.
•	Словари фильтров: в репозитории (packages/filters/dictionaries/) или вынести в /etc/skazka/dictionaries/ (если нужно менять без деплоя).
•	Секреты: только /etc/skazka/skazka.env. Никогда в git.
•	Бэкапы: только /var/backups/skazka/.
________________________________________
7. Политика обслуживания (минимум)
•	Очистка данных: удалять записи старше 30 дней (сессии/события/платежи по правилам).
•	Ротация логов: не копить бесконечно (logrotate или docker-лог-драйвер).
•	Бэкап Postgres: ежедневный (минимум).
•	Восстановление: скрипт restore_db.sh должен существовать (даже если пока “черновой”).
________________________________________
8. DoD для этого файла
•	Определены корневые пути на сервере
•	Дерево репозитория задано и движок выделен (packages/engine/)
•	Дерево окружения вне репо задано (/etc, /var/lib, /var/log, /var/backups)
•	Список сервисов и способ управления (systemd или docker) определены
•	Политика хранения/ротации/бэкапов описана кратко и однозначно
============================================================
ПРИЛОЖЕНИЕ A. Реестры контента: темы, стили, теги (v0.1)
============================================================

В проекте вводится слой "контент-реестров" (данные, а не текст документации).
Цель: разделить "что показываем/генерим" (данные) и "как это работает" (описание).

SOURCE OF TRUTH (репозиторий):
- content/themes.yaml — реестр тем (миров) для L2: title/subtitle/tags/style_default и универсальный starter_brief.
- content/styles.yaml — реестр стилевых пакетов (style_id → правила голоса/манера текста).
- content/tag_vocab.yaml — словарь допустимых тегов (ограниченный, без синонимов и самодеятельности).
- docs/GEN_CONTRACT.md — нормативный контракт формата генерации (MVP).

Правило синхронизации:
- DOCX фиксируют канон правил и UX (человекочитаемо).
- YAML/MD в репо фиксируют данные и контракты (машиночитаемо) и являются источником истины.

Возрастной диапазон MVP:
- общий диапазон 4–10 лет
- разделения по возрастным подрежимам пока нет (может появиться позже как отдельная версия/итерация).


PATCH 2 — 00_Обзор_проект.docx
Куда вставлять: в раздел “Границы проекта / Что НЕ входит в MVP” или “Дорожная карта (после MVP)” (если такой есть).
Если нет — добавь маленький подраздел в конце: “После MVP (планы)”.
Что вставлять:
После MVP (планы расширения монетизации)
Вне MVP v0.1 планируются три расширения, не меняющие базовый формат сказки (шаги/структура), но повышающие ценность продукта:
1.	Персонализация под ребёнка (имя/возраст/интересы) как платная опция.
2.	Совместное прохождение (ребёнок + родитель) как отдельный режим/пакет.
3.	Печать физической книги на базе PDF (PDF→Print) как продукт высокого чека.

