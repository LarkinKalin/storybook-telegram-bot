ID: SKAZKA-TG-DOC-90
Статус: ACTIVE
Владелец: Архитектор
Назначение: фиксировать принятые архитектурные решения и изменения канона (что принято, когда, почему, какие файлы затронуты).
________________________________________
2026-01-22 — Принята схема БД v0.1 и SQL миграции (TG.3.2.01)
Контекст: требуется зафиксировать контракт данных до бизнес-логики, чтобы переносить runtime sessions из памяти в Postgres без гаданий и расхождений.
Решение:
Принята и зафиксирована схема БД v0.1 как SQL миграции Postgres. Схема покрывает пользователей, сессии, события, платежи, confirm-идемпотентность, лимиты и UX-дедуп.
Ключевые инварианты/каноны (v0.1):
•	Сессия адресуется sid8 и загружается только по (tg_id, sid8); sid8 криптослучайный.
•	Не более одной ACTIVE сессии на пользователя (partial unique index).
•	session_events защищён от дублей: UNIQUE(session_id, step).
•	confirm_requests обрабатывается только по (tg_id, rid8) и имеет консистентность статусов/результата.
•	usage_windows реализует rolling окно 12 часов: лимит 150 сообщений и 20 новых сессий; “одно активное окно” обеспечивается транзакционным upsert.
•	ui_events добавлен для дедуп/ретраев UI-событий, включая пересказ (recap) и защиту от повторов.
Файлы/артефакты (источник истины):
•	packages/db/migrations/001_init_schema_v0_1.sql
•	packages/db/README.md
•	reports/OPS_DB_TON.md (строка факта TG.3.2.01)
•	reports/IMPLEMENTATION_INDEX.md (строка факта TG.3.2.01)
Коммит:
f729afd772f3bdf4c8ffd99e3657fe8e30aaff7d — feat(db): add v0.1 postgres schema migrations
Проверка применения:
Миграция применена в контейнерном Postgres (POSTGRES_USER=skazka, POSTGRES_DB=skazka) без ошибок. Таблицы созданы:
users, sessions, session_events, payments, confirm_requests, usage_windows, ui_events.
ПАТЧ ДЛЯ 90_Журнал_решений_и_изменений.docx
Вставить в конец документа целиком
________________________________________
ADR: TG.5.1.01 — LLM STORY_STEP Contract v0.1
ID: ADR-TG.5.1.01
Дата: <дата коммита>
Статус: ACCEPTED
Связанный квест: TG.5.1.01
Документы-источники истины:
•	30_LLM_контракт_и_промпты (Canon v0.1, REV2 FINAL hardening++)
•	10_UX_Телеграм_бота (UI / handlers)
•	50_База_данных_и_платежи_TON (placeholders)
________________________________________
Контекст
Проект использует LLM для генерации шагов интерактивной сказки (STORY_STEP).
До фиксации контракта логика LLM, engine и runtime могли смешиваться, что приводило к:
•	дрейфу форматов,
•	неконтролируемым ретраям,
•	росту контекста и стоимости,
•	soft-lock сценариям в детском UX.
Требовалось зафиксировать жёсткий контракт и правила деградации без влияния на механику движка.
________________________________________
Принятое решение
1.	LLM изолирован от engine
Engine детерминирован и не зависит от LLM.
LLM отвечает только за:
o	narration / final_narration
o	choices
o	memory
2.	Жёсткий JSON-only контракт
Ответ LLM — строго валидный JSON.
Любой текст вне JSON запрещён.
3.	Индексация шагов
o	step0 — канонический индекс шага (0..N−1)
o	step_ui = step0 + 1
4.	Финал истории
is_final вычисляется runtime как (step0 == n_total - 1).
Входной is_final при рассинхроне игнорируется и логируется как anomaly.
5.	Memory по контракту
Поле memory обязательно по схеме, но missing/whitespace допустим.
Missing memory:
o	не триггерит retry
o	приводит к fallback с clamp последнего текста шага
6.	Retry policy
Retry строго один.
Retry разрешён только по формализованным кодам ошибок.
Поведение после исчерпания retry детерминировано:
o	free_text-only при наличии narration
o	hard-fail при отсутствии текста
7.	Anti-soft-lock гарантия
В режиме OK_FREE_TEXT_ONLY свободный ввод никогда не отключается,
независимо от noise-фильтров и классификаторов.
8.	Контроль стоимости и наблюдаемость
o	clamp контекста до 800 chars
o	метрики размеров prompt/response
o	логирование retry_reason
________________________________________
Последствия
•	LLM-контур заменяем без влияния на engine.
•	Формат стабилен и диагностируем.
•	UX защищён от soft-lock сценариев.
•	Стоимость контролируема за счёт clamp и метрик.
________________________________________
Статус
Решение принято и зафиксировано как Canon v0.1.
Изменения допускаются только через новый ADR.
90.ADR.TG.7.3.MODELS — Выбор моделей для MVP: Kimi (text) + FLUX (images)
Статус: ACCEPTED
Дата: 2026-01-28
Контекст:
Практика показала неудовлетворительное качество/стабильность альтернативных вариантов (MiniMax, OpenAI) для нашей задачи сказок и строгого JSON-контракта.

Решение:
1) Текстовый контур:
- провайдер: OpenRouter
- модель: moonshotai/kimi-k2.5
- режим: JSON-only через контракт, reasoning выключен

2) Контур изображений:
- провайдер: OpenRouter
- модель: black-forest-labs/flux.2-pro
- схема: 1-я картинка t2i, последующие i2i с reference первой картинки

Последствия:
- Реализация делается двухконтурной: текст и изображения не смешиваются.
- Ошибка генерации изображения не блокирует прохождение.
- В БД добавляется слой assets/session_images (внешнее хранение бинарников).
